name: Boundary CI

on:
  push:
    branches: [ main, 'feat/**' ]
  pull_request:
    branches: [ main ]

jobs:
  # =============================================================================
  # Lint all code
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Lint with clj-kondo
        run: |
#          clojure -M:clj-kondo --lint \
#            libs/core/src \
#            libs/observability/src \
#            libs/platform/src \
#            libs/user/src \
#            libs/admin/src \
#            libs/storage/src \
#            libs/external/src \
#            libs/scaffolder/src
  
  # =============================================================================
  # Documentation drift check (warn-only)
  # =============================================================================
  docs-lint:
    name: Docs Lint
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run docs-lint
        run: clojure -M:docs-lint
      
      - name: Upload docs-lint report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docs-lint-report
          path: build/docs-lint/
          retention-days: 14
  
  # =============================================================================
  # Run all tests from root project
  # =============================================================================
  test:
    name: Test All Libraries
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run all tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters-long"
        run: clojure -M:test
