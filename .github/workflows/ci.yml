name: Boundary CI

on:
  push:
    branches: [ main, 'feat/**' ]
  pull_request:
    branches: [ main ]

jobs:
  # =============================================================================
  # Lint all code
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Lint with clj-kondo
        run: |
          clojure -M:dev:clj-kondo --lint \
            libs/core/src \
            libs/observability/src \
            libs/platform/src \
            libs/user/src \
            libs/admin/src \
            libs/storage/src \
            libs/external/src \
            libs/scaffolder/src
  
  # =============================================================================
  # Test individual libraries
  # =============================================================================
  test-core:
    name: Test boundary/core
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('libs/core/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run tests
        working-directory: libs/core
        run: clojure -M:test
  
  test-observability:
    name: Test boundary/observability
    runs-on: ubuntu-latest
    needs: [lint, test-core]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('libs/observability/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run tests
        working-directory: libs/observability
        run: clojure -M:test
  
  test-platform:
    name: Test boundary/platform
    runs-on: ubuntu-latest
    needs: [lint, test-observability]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('libs/platform/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run tests
        working-directory: libs/platform
        run: clojure -M:test
  
  test-user:
    name: Test boundary/user
    runs-on: ubuntu-latest
    needs: [lint, test-platform]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('libs/user/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run tests
        working-directory: libs/user
        run: clojure -M:test
  
  test-admin:
    name: Test boundary/admin
    runs-on: ubuntu-latest
    needs: [lint, test-user]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('libs/admin/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run tests
        working-directory: libs/admin
        run: clojure -M:test
  
  # =============================================================================
  # Summary job
  # =============================================================================
  test-summary:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [test-core, test-observability, test-platform, test-user, test-admin]
    
    steps:
      - name: Summary
        run: |
          echo "âœ… All library tests passed!"
          echo "Libraries tested:"
          echo "  - boundary/core"
          echo "  - boundary/observability"
          echo "  - boundary/platform"
          echo "  - boundary/user"
          echo "  - boundary/admin"
