name: Boundary CI

on:
  push:
    branches: [ main, 'feat/**' ]
  pull_request:
    branches: [ main ]

jobs:
  # =============================================================================
  # Lint all code
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Clear clj-kondo cache
        run: rm -rf .clj-kondo/.cache/* 2>/dev/null || true
      
      - name: Lint with clj-kondo
        run: |
          clojure -M:clj-kondo --lint \
            libs/core/src \
            libs/observability/src \
            libs/platform/src \
            libs/user/src \
            libs/admin/src \
            libs/storage/src \
            libs/external/src \
            libs/scaffolder/src
  
  # =============================================================================
  # Documentation drift check (warn-only)
  # =============================================================================
  docs-lint:
    name: Docs Lint
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run docs-lint
        run: clojure -M:docs-lint
      
      - name: Upload docs-lint report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docs-lint-report
          path: build/docs-lint/
          retention-days: 14
  
  # =============================================================================
  # Test individual libraries (run from root to ensure all dependencies available)
  # =============================================================================
  test-core:
    name: Test boundary/core
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run tests
        run: clojure -M:test :core
  
  test-observability:
    name: Test boundary/observability
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run docs-lint
        run: clojure -M:docs-lint
      
      - name: Upload docs-lint report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docs-lint-report
          path: build/docs-lint/
          retention-days: 14
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run tests
        run: clojure -M:test :observability
  
  test-platform:
    name: Test boundary/platform
    runs-on: ubuntu-latest
    needs: [lint, test-observability]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run tests
        run: clojure -M:test :platform
  
  test-user:
    name: Test boundary/user
    runs-on: ubuntu-latest
    needs: [lint, test-platform]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test :user
  
  # =============================================================================
  # Run all tests from root project
  # =============================================================================
  test:
    name: Test All Libraries
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-
      
      - name: Run all tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters-long"
        run: clojure -M:test
      - name: Run tests
        run: clojure -M:test :admin
  
  # =============================================================================
  # Summary job
  # =============================================================================
  test-summary:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [test-core, test-observability, test-platform, test-user, test-admin]
    
    steps:
      - name: Summary
        run: |
          echo "âœ… All library tests passed!"
          echo "Libraries tested:"
          echo "  - boundary/core"
          echo "  - boundary/observability"
          echo "  - boundary/platform"
          echo "  - boundary/user"
          echo "  - boundary/admin"
