name: Boundary CI

on:
  push:
    branches: [ main, 'feat/**' ]
  pull_request:
    branches: [ main ]

jobs:
  # =============================================================================
  # Lint all code
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Clear clj-kondo cache
        run: rm -rf .clj-kondo/.cache/* 2>/dev/null || true

      - name: Lint with clj-kondo
        run: |
          clojure -M:clj-kondo --lint \
            libs/core/src \
            libs/observability/src \
            libs/platform/src \
            libs/user/src \
            libs/admin/src \
            libs/storage/src \
            libs/cache/src \
            libs/jobs/src \
            libs/tenant/src \
            libs/email/src \
            libs/realtime/src \
            libs/external/src \
            libs/scaffolder/src

  # =============================================================================
  # Documentation drift check (warn-only)
  # =============================================================================
  docs-lint:
    name: Docs Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run docs-lint
        run: clojure -M:docs-lint

      - name: Upload docs-lint report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docs-lint-report
          path: build/docs-lint/
          retention-days: 14

  # =============================================================================
  # Test individual libraries (run from root to ensure all dependencies available)
  # =============================================================================
  test-core:
    name: Test boundary/core
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :core

  test-observability:
    name: Test boundary/observability
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :observability

  test-platform:
    name: Test boundary/platform
    runs-on: ubuntu-latest
    needs: [lint, test-observability]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :platform

  test-user:
    name: Test boundary/user
    runs-on: ubuntu-latest
    needs: [lint, test-platform]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :user

  test-admin:
    name: Test boundary/admin
    runs-on: ubuntu-latest
    needs: [lint, test-user]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :admin

  test-storage:
    name: Test boundary/storage
    runs-on: ubuntu-latest
    needs: [lint, test-platform]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :storage

  test-cache:
    name: Test boundary/cache
    runs-on: ubuntu-latest
    needs: [lint, test-platform]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :cache

  test-jobs:
    name: Test boundary/jobs
    runs-on: ubuntu-latest
    needs: [lint, test-platform]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :jobs

  test-tenant:
    name: Test boundary/tenant
    runs-on: ubuntu-latest
    needs: [lint, test-platform]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :tenant

  test-email:
    name: Test boundary/email
    runs-on: ubuntu-latest
    needs: [lint, test-platform]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :email

  test-realtime:
    name: Test boundary/realtime
    runs-on: ubuntu-latest
    needs: [lint, test-platform]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :realtime

  test-scaffolder:
    name: Test boundary/scaffolder
    runs-on: ubuntu-latest
    needs: [lint, test-platform]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters"
        run: clojure -M:test:db/h2 :scaffolder

  # =============================================================================
  # Run all tests from root project
  # =============================================================================
  test:
    name: Test All Libraries
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: 1.11.1.1347

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: ${{ runner.os }}-clojure-

      - name: Run all tests
        env:
          JWT_SECRET: "ci-test-secret-minimum-32-characters-long"
        run: clojure -M:test:db/h2

  # =============================================================================
  # Summary job
  # =============================================================================
  test-summary:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [test-core, test-observability, test-platform, test-user, test-admin, test-storage, test-cache, test-jobs, test-tenant, test-email, test-realtime, test-scaffolder]

    steps:
      - name: Summary
        run: |
          echo "âœ… All library tests passed!"
          echo "Libraries tested:"
          echo "  - boundary/core"
          echo "  - boundary/observability"
          echo "  - boundary/platform"
          echo "  - boundary/user"
          echo "  - boundary/admin"
          echo "  - boundary/storage"
          echo "  - boundary/cache"
          echo "  - boundary/jobs"
          echo "  - boundary/tenant"
          echo "  - boundary/email"
          echo "  - boundary/realtime"
          echo "  - boundary/scaffolder"
