= Pedestal Adapter Abandonment - Complete Summary (Historical)
:toc:
:toclevels: 2

[NOTE]
====
**Historical Document** - This change report documents the December 2024 investigation and abandonment of the Pedestal router adapter. This document is preserved as a historical record of architectural decisions and lessons learned. See link:../adr/ADR-009-reitit-exclusive-router.adoc[ADR-009] for the formal decision record.
====

== Executive Summary

**Decision**: Pedestal router adapter abandoned; Reitit chosen as exclusive HTTP router

**Status**: ✅ **COMPLETE** - All cleanup tasks finished, tests passing

**Impact**: Simplified architecture, maintained clean normalized routing format

---

== What Was Done

=== 1. Investigation & Analysis ✅

**Discovered**: Fundamental architectural incompatibility between Ring/Reitit and Pedestal

**Key Finding**: 
- Ring uses function composition: `(handler request) → response`
- Pedestal uses interceptor chains: `context → interceptor-chain → context`
- Cannot be bridged without complex, leaky abstractions

**Documented**: Comprehensive analysis in `docs/architecture/pedestal-adapter-analysis.adoc`

=== 2. Code Cleanup ✅

**Deleted Files**:
- `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/platform/shell/http/pedestal_router.clj` (draft implementation)
- `test/boundary/platform/shell/http/pedestal_router_test.clj` (test suite)

**Modified Files**:
- `deps.edn` - Removed Pedestal dependencies
  - ❌ `io.pedestal/pedestal.service`
  - ❌ `io.pedestal/pedestal.route`

=== 3. Documentation ✅

**Created**:
- `docs/adr/ADR-009-reitit-exclusive-router.adoc` - Official decision record
- `docs/architecture/pedestal-adapter-analysis.adoc` - Technical analysis

**Updated**:
- `docs/adr/README.adoc` - Added ADR-009 to index

=== 4. Verification ✅

**Test Results**: All tests passing
```
486 tests, 2574 assertions, 0 failures ✅
```

**Linting**: Clean (no new errors introduced)

---

== Architecture Outcome

=== What We Have Now

```
┌─────────────────────────────────────────────┐
│  Module Route Definitions                   │
│  (Normalized EDN Format)                    │
│  • boundary.user.shell.http                 │
│  • boundary.inventory.shell.http            │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  System Wiring                              │
│  (Combines module routes)                   │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  IRouter Protocol (Abstraction)             │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  Reitit Router Adapter                      │
│  (Only Implementation)                      │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  Ring Handler                               │
│  (HTTP Request Processing)                  │
└─────────────────────────────────────────────┘
```

=== Key Components

1. **Normalized Route Format** (ADR-008)
   - Framework-agnostic EDN structure
   - Clean module interfaces
   - Self-documenting schemas

2. **IRouter Protocol**
   - Abstraction layer (currently single implementation)
   - Provides flexibility for future changes

3. **Reitit Adapter** (Only Implementation)
   - `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/platform/shell/http/reitit_router.clj`
   - Converts normalized routes → Reitit routes
   - Includes conflict resolution (`:conflicts nil`)

---

== What We Achieved

=== ✅ Normalized Routing Format

**Goal**: Framework-agnostic route definitions  
**Status**: COMPLETE

All modules now use normalized format:

```clojure
(defn user-routes-normalized [service config]
  {:api
   [{:path "/api/users"
     :name :users
     :methods
     {:get {:handler (handlers/list-users service config)
            :name :list-users}
      :post {:handler (handlers/create-user service config)
             :name :create-user}}}]
   
   :web [...]
   :static [...]})
```

**Benefits**:
- Clean, readable route definitions
- Framework independent (in principle)
- Easy to test and validate
- Self-documenting structure

=== ✅ Fixed Reitit Route Conflicts

**Problem**: Route conflicts between specific (`/users/new`) and parameterized (`/users/:id`) paths

**Solution**: Added `:conflicts nil` to Reitit router configuration

**Result**: All 486 tests passing

=== ✅ Module Migration Complete

**Migrated Modules**:
- ✅ User module (`boundary.user.shell.http`)
  - 5 API routes
  - 15 web UI routes
  
- ✅ Inventory module (`boundary.inventory.shell.http`)
  - 2 API routes
  - 1 web route

**Deprecated**:
- `migration_helpers.clj` - No longer needed, marked DEPRECATED

=== ✅ Clean System Wiring

**Simplified**:
- Removed Reitit→Normalized→Reitit conversion
- Direct normalized routes to router adapter
- Cleaner dependency structure

---

== Decision Rationale

=== Why Abandon Pedestal?

1. **Architectural Incompatibility**
   - Ring: synchronous, function-based
   - Pedestal: async, interceptor-based
   - Cannot bridge without losing benefits

2. **YAGNI Principle**
   - No concrete need for router swapping
   - Reitit meets all current requirements

3. **Complexity Not Justified**
   - Complex adapter = bugs + maintenance
   - No clear benefits over Reitit

4. **Focus on Value**
   - Better to build features than infrastructure
   - Normalized format still provides value

=== Why Keep IRouter Protocol?

Even with single implementation, the protocol provides:

1. **Documentation**: Clear interface contract
2. **Structure**: Organized code patterns
3. **Future Flexibility**: Easy to add implementations if needed
4. **Testability**: Can mock for testing
5. **Separation of Concerns**: Clean boundaries

---

== Current Status

=== File Inventory

**Created**:
- ✅ `docs/adr/ADR-009-reitit-exclusive-router.adoc`
- ✅ `docs/architecture/pedestal-adapter-analysis.adoc`

**Modified**:
- ✅ `deps.edn` (removed Pedestal deps)
- ✅ `docs/adr/README.adoc` (added ADR-009)
- ✅ `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/user/shell/http.clj` (normalized routes)
- ✅ `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/inventory/shell/http.clj` (normalized routes)
- ✅ `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/platform/shell/http/reitit_router.clj` (conflict fix)

**Deleted**:
- ✅ `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/platform/shell/http/pedestal_router.clj`
- ✅ `test/boundary/platform/shell/http/pedestal_router_test.clj`

**Deprecated**:
- ⚠️ `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/platform/shell/http/migration_helpers.clj`

=== Test Status

```
✅ 486 tests
✅ 2574 assertions
✅ 0 failures
✅ 0 errors
```

**Test Coverage**:
- Unit tests: Passing
- Integration tests: Passing
- System tests: Passing

---

## Lessons Learned

### 1. Research Architecture First

**Lesson**: Should have validated Pedestal compatibility before implementation

**Impact**: Saved 3-5 days of complex implementation that wouldn't work

**Future**: Always research architectural compatibility upfront

### 2. Architectural Patterns Are Hard to Bridge

**Lesson**: Ring (synchronous functions) and Pedestal (async interceptors) are fundamentally different

**Impact**: Cannot create clean adapter without losing benefits of one approach

**Future**: Choose one paradigm and commit to it

### 3. YAGNI is Real

**Lesson**: We built router flexibility without concrete need

**Impact**: Added complexity for hypothetical future requirements

**Future**: Build flexibility when you need it, not "just in case"

### 4. Abstractions Have Value Beyond Implementation

**Lesson**: Normalized routing format valuable even with single implementation

**Impact**: Clean module interfaces, better documentation, easier testing

**Future**: Consider documentation/structure value of abstractions

### 5. Analysis Prevents Waste

**Lesson**: Deep investigation saved us from wasted implementation effort

**Impact**: Made informed decision quickly

**Future**: Invest in analysis before major implementations

---

## Next Steps Completed

### ✅ What We Did

1. ✅ **Investigated Pedestal architecture** - Discovered incompatibility
2. ✅ **Created analysis document** - Comprehensive comparison
3. ✅ **Made decision** - Abandon Pedestal adapter
4. ✅ **Deleted draft code** - Cleaned up files
5. ✅ **Removed dependencies** - Updated deps.edn
6. ✅ **Created ADR-009** - Documented decision
7. ✅ **Updated ADR index** - Added to README
8. ✅ **Verified tests** - All passing
9. ✅ **Created summary** - This document

### ✅ What's Complete

**Normalized Routing Initiative**: COMPLETE
- ✅ Normalized format defined and implemented
- ✅ All modules migrated
- ✅ System wiring simplified
- ✅ Router conflicts resolved
- ✅ Tests passing
- ✅ Documentation complete

---

## Future Considerations

### When to Reconsider Router Choice

Revisit this decision if:

1. **Performance Requirements**: Need for async/non-blocking processing
2. **Pedestal-Specific Features**: Requirements only Pedestal provides
3. **Framework Issues**: Critical bugs or maintenance problems with Reitit
4. **Team Expertise**: Team has strong Pedestal preference
5. **Architectural Shift**: Move away from Ring paradigm entirely

### Available Options If Needed

If requirements change:

1. **Option 1**: Continue with Reitit (most likely)
2. **Option 2**: Full Pedestal migration (bypass abstraction)
3. **Option 3**: Custom router implementation
4. **Option 4**: Redesign abstraction for both patterns

### What's Preserved

The normalized routing format provides a **migration path** if needed:
- Routes are framework-agnostic data
- Can be transformed to any router format
- Clean module interfaces remain intact

---

## References

### Documentation

- **ADR-008**: link:../adr/ADR-008-normalized-routing-abstraction.adoc[Normalized Routing Abstraction]
- **ADR-009**: link:../adr/ADR-009-reitit-exclusive-router.adoc[Reitit Exclusive Router]
- **Analysis**: link:pedestal-adapter-analysis.adoc[Pedestal Adapter Analysis]

### Code

- **IRouter Protocol**: `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/platform/ports.clj`
- **Reitit Adapter**: `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/platform/shell/http/reitit_router.clj`
- **User Routes**: `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/user/shell/http.clj`
- **Inventory Routes**: `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/inventory/shell/http.clj`
- **System Wiring**: `link:https://github.com/thijs-creemers/boundary/blob/main/src/boundary/platform/shell/system/wiring.clj`

### External

- **Reitit**: https://cljdoc.org/d/metosin/reitit/
- **Pedestal**: https://pedestal.io/
- **Ring**: https://github.com/ring-clojure/ring

---

**Status**: ✅ COMPLETE - All tasks finished successfully

**Date**: 2024-12-06

**Outcome**: Cleaner architecture, proven solution, tests passing
