== User Module Observability Reference

[[toc]]
[[toctitle]]
Table of Contents

* link:#_overview[Overview]
** link:#_integration_approaches[Integration Approaches]
*** link:#_modern_approach_interceptor_pattern[Modern Approach: Interceptor Pattern ‚≠ê]
*** link:#_legacy_approach_manual_integration[Legacy Approach: Manual Integration]
* link:#_logging[Logging]
** link:#_business_and_audit_events[Business and Audit Events]
* link:#_metrics[Metrics]
** link:#_modern_approach_automatic_metrics_via_interceptors[Modern Approach: Automatic Metrics via Interceptors]
** link:#_legacy_approach_manual_metrics_integration[Legacy Approach: Manual Metrics Integration]
** link:#_user_lifecycle_counters[User Lifecycle Counters]
** link:#_session_lifecycle_counters[Session Lifecycle Counters]
** link:#_validation_and_error_metrics[Validation and Error Metrics]
** link:#_gauge_metrics[Gauge Metrics]
** link:#_metric_tags[Metric Tags]
* link:#_error_reporting[Error Reporting]
** link:#_modern_approach_automatic_error_reporting_via_interceptors[Modern Approach: Automatic Error Reporting via Interceptors]
** link:#_legacy_approach_manual_error_reporting_integration[Legacy Approach: Manual Error Reporting Integration]
** link:#_exception_reporting[Exception Reporting]
** link:#_breadcrumbs[Breadcrumbs]
** link:#_error_tags[Error Tags]
* link:#_integration_examples[Integration Examples]
** link:#_modern_approach_interceptor_based_integration[Modern Approach: Interceptor-Based Integration]
** link:#_legacy_approach_manual_integration_example[Legacy Approach: Manual Integration Example]
* link:#_see_also[See Also]

[[preamble]]
This document describes the observability integration in the user module, acting as the primary reference for end-to-end observability integration in Boundary.

[width="100%",cols="50%,50%",]
|===
|__ a|
*üéØ Multi-Layer Interceptor Pattern Achievement*

The User module has been *fully converted* to use Boundary‚Äôs multi-layer interceptor pattern, representing a major framework evolution achievement:

*Conversion Results:* - ‚úÖ *31/31 methods* converted across service and persistence layers - ‚úÖ *48-64% code reduction* through boilerplate elimination - ‚úÖ *200{plus} manual observability calls* replaced with automatic integration - ‚úÖ *100% business logic preservation* - core functions remain pure

*Modern Implementation*: All user operations now benefit from automatic observability via interceptors, with business logic focused purely on domain concerns.

*Legacy Documentation*: The comprehensive manual integration examples below are maintained for reference and advanced customization scenarios.

|===

[[_overview]]
=== link:#_overview[]Overview

The user module combines logging, metrics, and error reporting across REST, CLI, and shell services. It serves as a production-ready example of how feature modules should integrate observability capabilities.

[[_integration_approaches]]
==== link:#_integration_approaches[]Integration Approaches

[[_modern_approach_interceptor_pattern]]
===== link:#_modern_approach_interceptor_pattern[]Modern Approach: Interceptor Pattern ‚≠ê

*Current implementation in production*

The user module now uses Boundary‚Äôs multi-layer interceptor pattern for seamless observability integration:

[source,highlightjs,highlight]
----
;; Service layer - Pure business logic
(defn register-user-service [deps user-data]
  ;; Interceptors automatically handle:
  ;; - Entry/exit logging with correlation IDs
  ;; - Success/failure metrics (user-registrations-attempted/successful/failed)
  ;; - Exception reporting with rich context
  ;; - Business event logging (user-registered)
  ;; - Performance timing (user-operation-duration histogram)
  (validate-user-data user-data)
  (create-user-record deps user-data))

;; Persistence layer - Pure data access
(defn save-user-persistence [deps user]
  ;; Interceptors automatically handle:
  ;; - Database operation timing
  ;; - Connection pool metrics
  ;; - Query logging with sanitized parameters
  ;; - Database exception reporting
  (sql/insert! (:database deps) :users user))
----

*Key Benefits:* - *Zero Boilerplate*: No manual observability calls in business logic - *Automatic Context*: Correlation IDs, user context, user context flow seamlessly - *Consistent Patterns*: Standardized observability across all operations - *Pure Functions*: Business logic remains focused on domain concerns

[[_legacy_approach_manual_integration]]
===== link:#_legacy_approach_manual_integration[]Legacy Approach: Manual Integration

*Historical reference and advanced customization*

The comprehensive manual integration patterns documented below demonstrate the observability capabilities that are now handled automatically by interceptors.

[[_logging]]
=== link:#_logging[]Logging

*Service namespace:* `boundary.user.shell.service`

All key operations log structured events using `boundary.logging.core`:

* `register-user` ‚Äì registration attempts, duplicates, and success events
* `authenticate-user` ‚Äì session creation and login pathway
* `validate-session` ‚Äì session validity checks and expiry
* `logout-user` ‚Äì single-session logout
* `logout-user-everywhere` ‚Äì global logout across all sessions
* `get-user-by-id`, `get-user-by-email`, `list-users`, `update-user-profile`, `deactivate-user`, `permanently-delete-user`

[[_business_and_audit_events]]
==== link:#_business_and_audit_events[]Business and Audit Events

Business / audit events (via `log-business-event` and `audit-user-action`):

* `user-registered`, `user-session-started`, `user-session-ended`
* User lifecycle actions: `deactivate`, `hard-delete`, `logout`, `logout-everywhere`

[[_metrics]]
=== link:#_metrics[]Metrics

[[_modern_approach_automatic_metrics_via_interceptors]]
==== link:#_modern_approach_automatic_metrics_via_interceptors[]Modern Approach: Automatic Metrics via Interceptors

With the interceptor pattern, all metrics are automatically collected without manual instrumentation:

[source,highlightjs,highlight]
----
;; Configuration enables automatic metrics collection
{:observability {:interceptors {:service-layer true
                               :persistence-layer true}}}

;; Functions automatically emit metrics - no manual calls needed
(defn register-user [deps user-data]
  ;; Automatically tracked:
  ;; - user-registrations-attempted (on entry)
  ;; - user-registrations-successful (on success)
  ;; - user-registrations-failed (on exception)
  ;; - user-operation-duration (timing histogram)
  ;; - active-sessions-total (gauge updates)
  (validate-user user-data)
  (save-user deps user-data))
----

[[_legacy_approach_manual_metrics_integration]]
==== link:#_legacy_approach_manual_metrics_integration[]Legacy Approach: Manual Metrics Integration

The user service historically emitted metrics via `boundary.metrics.core` (using counters, histograms, and gauges).

[[_user_lifecycle_counters]]
==== link:#_user_lifecycle_counters[]User Lifecycle Counters

* `user-registrations-attempted` / `user-registrations-successful` / `user-registrations-failed`
* `user-deactivations-attempted` / `user-deactivations-successful` / `user-deactivations-failed`
* `user-deletions-attempted` / `user-deletions-successful` / `user-deletions-failed`
* `user-logout-everywhere-attempted` / `user-logout-everywhere-successful` / `user-logout-everywhere-failed`

[[_session_lifecycle_counters]]
==== link:#_session_lifecycle_counters[]Session Lifecycle Counters

* `user-authentications-attempted` / `user-authentications-successful` / `user-authentications-failed`
* `session-creations`
* `session-validations-attempted` / `session-validations-successful` / `session-validations-failed`
* `session-invalidations-attempted` / `session-invalidations-successful` / `session-invalidations-failed`
* `user-sessions-invalidated` ‚Äì total sessions invalidated by `logout-user-everywhere`

[[_validation_and_error_metrics]]
==== link:#_validation_and_error_metrics[]Validation and Error Metrics

* `validation-errors` with tags such as `:operation`, `:error-code`

[[_gauge_metrics]]
==== link:#_gauge_metrics[]Gauge Metrics

* `active-sessions-total` ‚Äì total number of active sessions
* `active-sessions-by-user` ‚Äì active sessions per user (`:user-id` tag)

[[_metric_tags]]
==== link:#_metric_tags[]Metric Tags

All metrics are tagged where applicable with values such as:

* `:user-id` ‚Äì user identifier
* `:user-id` ‚Äì user identifier
* `:operation` ‚Äì operation name
* `:reason` ‚Äì failure reason (e.g. `"user-exists"`, `"system-error"`, `"expired"`, `"not-found"`)

[[_error_reporting]]
=== link:#_error_reporting[]Error Reporting

[[_modern_approach_automatic_error_reporting_via_interceptors]]
==== link:#_modern_approach_automatic_error_reporting_via_interceptors[]Modern Approach: Automatic Error Reporting via Interceptors

With interceptors, error reporting is handled automatically with rich context:

[source,highlightjs,highlight]
----
;; Any exception automatically triggers error reporting
(defn authenticate-user [deps credentials]
  ;; If validation or database operations throw:
  ;; Interceptors automatically:
  ;; - Report exception with full context
  ;; - Include breadcrumbs from operation lifecycle
  ;; - Add operation tags (component, operation, user-id)
  ;; - Sanitize sensitive data (passwords, tokens)
  ;; - Track error metrics
  (validate-credentials credentials)
  (find-user-by-email deps (:email credentials)))
----

[[_legacy_approach_manual_error_reporting_integration]]
==== link:#_legacy_approach_manual_error_reporting_integration[]Legacy Approach: Manual Error Reporting Integration

The user service historically used `boundary.error-reporting.core` to provide rich error context.

[[_exception_reporting]]
==== link:#_exception_reporting[]Exception Reporting

`report-application-error` wraps all major shell operations to capture unexpected exceptions:

* `register-user`
* `authenticate-user`
* `validate-session`
* `logout-user`
* `deactivate-user`
* `permanently-delete-user`
* `logout-user-everywhere`
* All read operations

[[_breadcrumbs]]
==== link:#_breadcrumbs[]Breadcrumbs

Breadcrumbs (via `add-breadcrumb`) document key lifecycle events:

* "Starting user registration", "User validation failed", "Duplicate user detected"
* "User authentication successful", "Session validation failed - expired"
* "User logout successful", "Session validation failed - not found"

[[_error_tags]]
==== link:#_error_tags[]Error Tags

Error tags consistently include:

* `:component` ‚Äì `"service.user"`
* `:operation` ‚Äì shell operation name (e.g. `"register-user"`)
* `:user-id` ‚Äì user IDentifier
* `:user-id` ‚Äì user identifier
* `:session-token` ‚Äì masked session token (where appropriate)

[[_integration_examples]]
=== link:#_integration_examples[]Integration Examples

[[_modern_approach_interceptor_based_integration]]
==== link:#_modern_approach_interceptor_based_integration[]Modern Approach: Interceptor-Based Integration

With interceptors enabled, the user service focuses purely on business logic:

[source,highlightjs,highlight]
----
;; Clean, focused service implementation
(defrecord UserService [user-repository session-repository]
  ports/IUserService

  (register-user [this user-data]
    ;; Pure business logic - interceptors handle all observability
    (validate-user-data user-data)
    (check-user-uniqueness user-repository user-data)
    (create-user-record user-repository user-data))

  (authenticate-user [this credentials]
    ;; Pure authentication logic - interceptors handle all observability
    (validate-credentials credentials)
    (let [user (find-user-by-email user-repository (:email credentials))]
      (verify-password user (:password credentials))
      (create-session session-repository user)))

  (validate-session [this session-token]
    ;; Pure validation logic - interceptors handle all observability
    (find-active-session session-repository session-token))

  (logout-user [this session-token]
    ;; Pure logout logic - interceptors handle all observability
    (invalidate-session session-repository session-token)))

;; Interceptor configuration handles all observability automatically
{:observability
 {:interceptors
  {:service-layer {:enabled true
                   :metrics {:track-timing true
                            :track-counts true
                            :track-errors true}
                   :logging {:log-entries true
                            :log-exits true
                            :log-errors true}
                   :error-reporting {:enabled true
                                    :include-context true
                                    :sanitize-data true}}
   :persistence-layer {:enabled true
                      :metrics {:track-db-timing true
                               :track-connection-pool true}
                      :logging {:log-queries true
                               :sanitize-parameters true}}}}}
----

[[_legacy_approach_manual_integration_example]]
==== link:#_legacy_approach_manual_integration_example[]Legacy Approach: Manual Integration Example

[source,highlightjs,highlight]
----
;; User service with observability
(defrecord UserService [user-repository
                        session-repository
                        logger
                        metrics-emitter
                        error-reporter]

  ports/IUserService

  (register-user [this user-data]
    (let [context {:operation "register-user"
                   :user-id (:user-id user-data)}]
      ;; Add breadcrumb
      (error-reporting/add-breadcrumb
        error-reporter
        "Starting user registration"
        "service.user"
        :info
        {:user-id (:user-id user-data)})

      ;; Time operation with histogram
      (metrics/time-with-histogram
        metrics-emitter
        "user-operation-duration"
        {:operation-type "register"
         :user-id (:user-id user-data)}
        (fn []
          ;; Log with function logging wrapper
          (logging/with-function-logging
            logger
            "register-user"
            context
            (fn []
              ;; Track attempt
              (metrics/increment-counter
                metrics-emitter
                "user-registrations-attempted"
                {:user-id (:user-id user-data)})

              (try
                ;; Business logic...
                (let [created-user (create-user! user-data)]
                  ;; Log business event
                  (logging/log-business-event
                    logger
                    "user-registered"
                    "user"
                    context
                    {:user-id (:id created-user)})

                  ;; Track success
                  (metrics/increment-counter
                    metrics-emitter
                    "user-registrations-successful"
                    {:user-id (:user-id user-data)})

                  created-user)

                (catch Exception e
                  ;; Report error
                  (error-reporting/report-application-error
                    error-reporter
                    e
                    "User registration failed"
                    {:extra {:operation "register-user"
                             :user-id (:user-id user-data)}
                     :tags {:component "service.user"
                            :operation "register-user"}})

                  ;; Track failure
                  (metrics/increment-counter
                    metrics-emitter
                    "user-registrations-failed"
                    {:user-id (:user-id user-data)
                     :reason "system-error"})

                  (throw e)))))))))
----

[[_see_also]]
=== link:#_see_also[]See Also

* link:observability-reference.html[Observability Module Reference]
* link:#architecture:observability-integration.adoc[Observability Integration Guide]
* link:#architecture:error-handling-observability.adoc[Error Handling & Observability Architecture]
