=== POST /api/v1/users

==== Purpose
Creates a new user account with role-based permissions and . This endpoint demonstrates the complete validation pipeline, core function integration, and error handling patterns of the Boundary framework.

==== Request

*Method:* `POST`
*Path:* `/api/v1/users`
*Content-Type:* `application/json`

*Query Parameters:*
[cols="1,1,1,3"]
|===
|Parameter |Type |Required |Description


|===

*Request Body Schema:*
[source,clojure]
----
{:user/email      [:string {:min 5 :max 255 :pattern #"^[^@]+@[^@]+\.[^@]+$"}]
 :user/role       [:enum :admin :user :viewer]
 :user/active     [:boolean]
 :user/user-id  [:maybe :uuid]}
----

*Example Request:*
[source,json]
----
{
  "email": "john.doe@example.com",
  "role": "user", 
  "active": true
}
----

==== Response

*Success Status:* `201 Created`
*Content-Type:* `application/json`

*Response Schema:*
[source,clojure]
----
{:data [:map
        {:user/id         :uuid
         :user/email      :string
         :user/role       :keyword
         :user/active     :boolean
         :user/user-id  :uuid
         :user/created-at :inst}]
 :meta [:map
        {:created-at :inst
         :version    :string}]}
----

*Example Response:*
[source,json]
----
{
  "data": {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "email": "john.doe@example.com",
    "role": "user",
    "active": true,
    "userId": "456e7890-e12b-34c5-a678-901234567890",
    "createdAt": "2023-12-15T10:30:00Z"
  },
  "meta": {
    "createdAt": "2023-12-15T10:30:00Z",
    "version": "1.0"
  }
}
----

==== Error Responses

*Status Codes:*
* `400 Bad Request` - Invalid input, validation errors, or malformed JSON
* `401 Unauthorized` - Missing or invalid authentication token
* `403 Forbidden` - Insufficient permissions for role assignment
* `409 Conflict` - User with email already exists
* `422 Unprocessable Entity` - Valid JSON but business rule violations
* `500 Internal Server Error` - Unexpected system error

*Error Response Format:*
[source,json]
----
{
  "type": "https://boundary.example.com/problems/validation-error",
  "title": "Validation Error",
  "status": 400,
  "detail": "One or more fields failed validation",
  "instance": "/api/v1/users",
  "errors": [
    {
      "field": "email",
      "code": "INVALID_FORMAT", 
      "message": "Email format is invalid"
    },
    {
      "field": "role",
      "code": "INVALID_ENUM_VALUE",
      "message": "Role must be one of: admin, user, viewer"
    }
  ]
}
----

*Business Rule Error Example:*
[source,json]
----
{
  "type": "https://boundary.example.com/problems/business-rule-violation",
  "title": "Business Rule Violation",
  "status": 422,
  "detail": "Cannot create admin user without proper authorization",
  "instance": "/api/v1/users",
  "errors": [
    {
      "rule": "ADMIN_CREATION_RESTRICTED",
      "message": "Admin role can only be assigned by existing admin users"
    }
  ]
}
----

==== Implementation Notes

* **Core Function**: `boundary.core.user/create-new-user` - Pure function that validates business rules and returns user data with effects
* **Repository Dependencies**: `IUserRepository` for email uniqueness checks and user persistence
* **Validation Pipeline**: Uses Malli schema with JSON transformer for type coercion
* **Business Rules**: 
  ** Email must be globally unique
  ** Admin role requires admin permissions to assign
  ** Active status defaults to true if not specified
* **Side Effects**: Welcome email sent for active users, audit log entry created

==== Examples

*CLI Equivalent:*
[source,bash]
----
boundary users create --email="john.doe@example.com" --role=user --active=true
----

*cURL Example:*
[source,bash]
----
curl -X POST http://localhost:8080/api/v1/users \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $AUTH_TOKEN" \
  -d '{
    "email": "john.doe@example.com",
    "role": "user",
    "active": true
  }'
----

*Test Coverage:*
* **Unit Tests**: `boundary.core.user-test/create-new-user-test` covers business logic
* **Integration Tests**: `boundary.shell.http-test/create-user-integration-test` covers full request lifecycle
* **Contract Tests**: Schema validation tests ensure request/response format compliance
