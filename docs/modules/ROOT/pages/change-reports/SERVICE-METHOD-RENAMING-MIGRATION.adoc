= IUserService Protocol Method Renaming Migration Guide
:toc:
:toclevels: 3
:date: January 2025

== Overview

This document describes the renaming of `IUserService` protocol methods to resolve Clojure protocol method name collisions and better align with the Functional Core / Imperative Shell (FC/IS) architecture.

== Rationale

=== Problem: Protocol Method Name Collisions

In Clojure, **protocol method names must be globally unique** across all protocols in a namespace. The original `IUserService` protocol shared method names with `IUserRepository` and `IUserSessionRepository`:

[source,clojure]
----
;; ❌ PROBLEM: These method names collide
(defprotocol IUserRepository
  (create-user [this user-data])
  (find-user-by-id [this user-id])
  ...)

(defprotocol IUserService  
  (create-user [this user-data])      ; ⚠️ Collision!
  (find-user-by-id [this user-id])    ; ⚠️ Collision!
  ...)
----

This caused Clojure warnings:
----
Warning: protocol #'boundary.user.ports/IUserService is overwriting 
method create-user of protocol IUserRepository
----

=== Solution: Domain-Specific Service Method Names

Following FC/IS principles, service methods should express **business operations** rather than mirror persistence-level CRUD operations:

* **Service Layer (Shell)**: Business operations using domain language
  ** Examples: `register-user`, `authenticate-user`, `deactivate-user`
* **Repository Layer (Adapters)**: Persistence operations using data language  
  ** Examples: `create-user`, `find-user-by-id`, `soft-delete-user`

This separation:

1. **Resolves collisions**: Unique method names across protocols
2. **Improves clarity**: Service intent explicit in method names
3. **Aligns with FC/IS**: Service orchestration distinct from data access
4. **Supports multi-interface consistency**: Same business vocabulary across REST API, CLI, Web

== Method Name Mapping

=== User Management Operations

[cols="1,1,2"]
|===
|Old Method Name |New Method Name |Business Operation

|`create-user`
|`register-user`
|Register a new user in the system

|`update-user`
|`update-user-profile`
|Update user profile information

|`find-user-by-id`
|`get-user-by-id`
|Retrieve user by unique identifier

|`find-user-by-email`
|`get-user-by-email`
|Look up user by email address

|`find-users-by-tenant`
|`list-users-by-tenant`
|List all users in a tenant

|`soft-delete-user`
|`deactivate-user`
|Deactivate user account (soft delete)

|`hard-delete-user`
|`permanently-delete-user`
|Permanently remove user from system
|===

=== Session Management Operations

[cols="1,1,2"]
|===
|Old Method Name |New Method Name |Business Operation

|`create-session`
|`authenticate-user`
|Authenticate user and create session

|`find-session-by-token`
|`validate-session`
|Validate session token

|`invalidate-session`
|`logout-user`
|Log out user and invalidate session

|`invalidate-all-user-sessions`
|`logout-user-everywhere`
|Log out user from all devices
|===

== What Changed

=== Protocol Definition

**File:** `src/boundary/user/ports.clj`

[source,clojure]
----
(defprotocol IUserService
  "Service-level user operations - business domain language."
  
  ;; User Management
  (register-user [this user-data]
    "Register a new user in the system.")
  
  (update-user-profile [this user-id changes]
    "Update user profile information.")
  
  (get-user-by-id [this user-id]
    "Retrieve user by unique identifier.")
  
  (get-user-by-email [this email tenant-id]
    "Look up user by email address within tenant.")
  
  (list-users-by-tenant [this tenant-id filters]
    "List all users in a tenant with optional filters.")
  
  (deactivate-user [this user-id]
    "Deactivate user account (soft delete).")
  
  (permanently-delete-user [this user-id]
    "Permanently remove user from system.")
  
  ;; Session Management
  (authenticate-user [this user-id tenant-id session-data]
    "Authenticate user and create new session.")
  
  (validate-session [this session-token]
    "Validate session token and return session info.")
  
  (logout-user [this session-token]
    "Log out user and invalidate specific session.")
  
  (logout-user-everywhere [this user-id]
    "Log out user from all devices by invalidating all sessions."))
----

=== Service Implementation

**File:** `src/boundary/user/shell/service.clj`

Service implementation updated to implement new method names while **continuing to call repository methods with their unchanged names**:

[source,clojure]
----
(defrecord UserService [user-repository session-repository]
  ports/IUserService
  
  (register-user [this user-data]
    ;; Service method: register-user
    ;; Repository method: create-user (unchanged)
    (.create-user user-repository user-data))
  
  (get-user-by-id [this user-id]
    ;; Service method: get-user-by-id  
    ;; Repository method: find-user-by-id (unchanged)
    (.find-user-by-id user-repository user-id))
  
  ;; ... other methods follow same pattern
  )
----

=== Call Sites Updated

All service consumers updated:

* `src/boundary/user/shell/cli.clj` - CLI command handlers
* `src/boundary/user/shell/http.clj` - HTTP route handlers
* `test/boundary/user/service_test.clj` - Service tests
* `test/boundary/user/cli_test.clj` - CLI tests
* `test/boundary/user/http_test.clj` - HTTP tests

== What Did NOT Change

=== Repository Interfaces (Unchanged)

The repository protocols remain **completely unchanged**:

[source,clojure]
----
;; ✅ NO CHANGES to repository protocols
(defprotocol IUserRepository
  (create-user [this user-data])
  (update-user [this user-id changes])
  (find-user-by-id [this user-id])
  (find-user-by-email [this email tenant-id])
  (find-users-by-tenant [this tenant-id filters])
  (soft-delete-user [this user-id])
  (hard-delete-user [this user-id]))

(defprotocol IUserSessionRepository
  (create-session [this session-data])
  (find-session-by-token [this token])
  (invalidate-session [this token])
  (invalidate-all-user-sessions [this user-id]))
----

Repository implementations (SQLite adapter, mock implementations) continue using the same method names.

=== Core Business Logic (Unchanged)

Pure business logic in `boundary.user.core.*` namespaces remains unchanged:

* `boundary.user.core.user` - User validation and business rules
* `boundary.user.core.session` - Session management logic

=== Database Schema (Unchanged)

No database schema changes required - this is purely a code-level refactoring.

== Migration Checklist

If you have custom code that calls `IUserService`:

. [ ] Update service method calls to use new names
. [ ] Do **NOT** change repository method calls
. [ ] Update any documentation referencing old service method names
. [ ] Run tests to verify: `clojure -M:test:db/h2`
. [ ] Check for protocol collision warnings in REPL startup

== Examples

=== Before (Old)

[source,clojure]
----
;; Service calls
(ports/create-user user-service user-data)
(ports/find-user-by-email user-service email tenant-id)
(ports/invalidate-session user-service token)

;; Repository calls (no change needed)
(ports/create-user user-repository user-data)
(ports/find-user-by-id user-repository user-id)
----

=== After (New)

[source,clojure]
----
;; Service calls - updated
(ports/register-user user-service user-data)
(ports/get-user-by-email user-service email tenant-id)
(ports/logout-user user-service token)

;; Repository calls - unchanged
(ports/create-user user-repository user-data)
(ports/find-user-by-id user-repository user-id)
----

== Benefits

=== Technical Benefits

1. **No Protocol Collisions**: Globally unique method names
2. **Clear Layer Separation**: Service vs. repository intent explicit
3. **Better Testability**: Mock implementations clearer to understand
4. **Compiler Support**: No runtime method resolution ambiguity

=== Business Benefits

1. **Domain Language**: Methods express business operations
2. **API Clarity**: REST/CLI endpoints map to business operations
3. **Documentation**: Self-documenting code with meaningful names
4. **Maintainability**: Easier for new developers to understand

== Related Documents

* link:../../../REFACTORING-SUMMARY.adoc[Main Refactoring Summary]
* link:../../../TEST-FIXES-SUMMARY.adoc[Test Fixes Summary]
* link:../../../warp.md[Boundary Architecture Guide]
* link:../../architecture/ports-and-adapters.adoc[Ports and Adapters Architecture]
* link:../../architecture/layer-separation.adoc[Layer Separation Guidelines]

== Compliance Status

[cols="2,1"]
|===
|Component |Status

|Protocol definitions
|✅ Updated

|Service implementation
|✅ Updated

|CLI handlers
|✅ Updated

|HTTP handlers
|✅ Updated

|Tests (service)
|✅ Updated

|Tests (CLI)
|✅ Updated

|Tests (HTTP)
|✅ Updated

|Repository interfaces
|✅ No changes needed

|Core business logic
|✅ No changes needed

|Database schema
|✅ No changes needed

|Test suite
|✅ 309 tests passing

|Linter
|✅ No new errors
|===

== Questions & Support

For questions about this migration:

1. Review the link:../../../REFACTORING-SUMMARY.adoc[detailed refactoring summary]
2. Check test examples in `test/boundary/user/`
3. Refer to architecture documentation in `docs/architecture/`

== Version History

[cols="1,1,3"]
|===
|Date |Version |Changes

|January 2025
|1.0
|Initial migration guide documenting IUserService method renaming
|===
