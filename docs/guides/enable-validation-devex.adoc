= Enable Enhanced Validation

[[overview]]
== Overview

Boundary includes an enhanced validation system with improved error messages, contextual help, and developer tools. These features are controlled by the `BND_DEVEX_VALIDATION` environment variable.

[TIP]
====
**Complete Validation Documentation**

This guide covers the basics. For comprehensive documentation including error message templates, snapshot testing, and coverage reporting, see {xref-validation-guide}[Validation Developer Guide].
====

[[enable-the-feature]]
== Enable the Feature

=== Set Environment Variable

[source,{shell}]
----
export BND_DEVEX_VALIDATION=true
----

=== Supported Values

[cols="1,1,2"]
|===
|Value |Enabled? |Description

|`true`, `1`, `yes`, `on`
|✅ Yes
|Enhanced features active

|`false`, `0`, `no`, `off`, unset
|❌ No
|Legacy behavior (default)
|===

=== Verify Activation

Check if the feature is enabled in the REPL:

[source,clojure]
----
user=> (require '[boundary.shared.core.config.feature-flags :as flags])
nil
user=> (flags/enabled? :devex-validation)
true  ; or false if not enabled
----

[[what-changes]]
== What Changes When Enabled?

=== Enhanced Error Messages

**Before** (legacy):
----
Validation failed: :email is required
----

**After** (enhanced):
----
Email is required when creating a user

Next steps:
1. Add the email field to your request
2. Ensure the field is not null or empty
3. Check API documentation for required fields
----

=== Contextual Help

Errors adapt based on:

* **Operation** - Different messages for create vs update
* **Role** - Admin-specific vs user-specific guidance
* **Field** - Field-specific help and examples

=== "Did You Mean?" Suggestions

[source]
----
Unknown field: 'emal'
Did you mean: 'email'?
----

[[repl-helpers]]
== REPL Helpers

The validation system includes REPL utilities for development.

=== Import the Helpers

[source,clojure]
----
user=> (require '[boundary.shared.tools.validation.repl :as v])
nil
----

=== View Validation Statistics

[source,clojure]
----
user=> (v/stats)
{:total-rules 45
 :modules {:user 45}
 :coverage 97}
----

=== List Validation Rules

[source,clojure]
----
;; All rules
user=> (v/list-rules)

;; Rules for specific module
user=> (v/list-rules {:module :user})
----

=== Generate Example Payloads

[source,clojure]
----
;; Generate example from Malli schema
user=> (v/snapshot->edn {:status :ok} {:seed 42})
{:email "alice@example.com"
 :name "Alice Doe"
 :role :user
 :user-id #uuid "550e8400-e29b-41d4-a716-446655440000"}
----

=== Export Validation Graph

Generate a GraphViz diagram of validation rules:

[source,clojure]
----
user=> (spit "build/validation-user.dot" 
           (v/rules->dot {:modules #{:user}}))
nil
----

Then render with GraphViz:

[source,{shell}]
----
dot -Tpng build/validation-user.dot -o docs/diagrams/validation-user.png
----

[[snapshot-testing]]
== Snapshot Testing

Snapshot tests ensure validation messages don't change unexpectedly.

=== Run Snapshot Tests

[source,{shell}]
----
clojure -M:test:db/h2 \
  --focus boundary.user.core.user-validation-snapshot-test
----

=== Update Snapshots

When you intentionally change validation behavior:

[source,{shell}]
----
UPDATE_SNAPSHOTS=true clojure -M:test:db/h2 \
  --focus boundary.user.core.user-validation-snapshot-test
----

[CAUTION]
====
**Review Before Updating**

Snapshot changes affect user-facing error messages. Always review the diff to ensure changes are intentional.
====

=== Snapshot Files Location

Snapshots are stored in:
----
test/boundary/user/core/snapshots/
  user-validation-snapshots.edn
----

[[coverage-reports]]
== Coverage Reports

Validation tests generate coverage reports automatically.

=== View Coverage

**Text format:**
[source,{shell}]
----
cat test/reports/coverage/user.txt
----

**EDN format** (machine-readable):
[source,{shell}]
----
cat test/reports/coverage/user.edn
----

**Example output:**
----
Validation Coverage Report
==========================

Module: User
Total Rules: 45
Covered: 44
Coverage: 97.78%

Uncovered Rules:
- user.email/format (missing test case)
----

[[integration-with-http-cli]]
== Integration with HTTP and CLI

Enhanced validation works automatically across all interfaces.

=== HTTP API

Error responses include enhanced messages:

[source,json]
----
{
  "type": "validation-error",
  "title": "Validation Failed",
  "status": 400,
  "errors": [
    {
      "field": "email",
      "code": "user.email/required",
      "message": "Email is required when creating a user",
      "suggestion": "Provide an email address for the user"
    }
  ]
}
----

=== CLI

CLI commands show enhanced error messages:

[source,{shell}]
----
$ clojure -M:cli user create --name "Alice"
Error: Email is required when creating a user

Next steps:
1. Add the --email flag
2. Use a valid email format (user@domain.com)
----

[[development-workflow]]
== Development Workflow

=== Typical Workflow

1. **Enable feature flag**
   [source,{shell}]
   ----
   export BND_DEVEX_VALIDATION=true
   ----

2. **Start watch mode**
   [source,{shell}]
   ----
   clojure -M:test:db/h2 --watch \
     --focus boundary.user.core.user-validation-snapshot-test
   ----

3. **Make changes to validation logic**

4. **Tests run automatically** - Review enhanced messages

5. **Update snapshots if needed**
   [source,{shell}]
   ----
   UPDATE_SNAPSHOTS=true clojure -M:test:db/h2 \
     --focus boundary.user.core.user-validation-snapshot-test
   ----

6. **Check coverage**
   [source,{shell}]
   ----
   cat test/reports/coverage/user.txt
   ----

[[learn-more]]
== Learn More

**Complete documentation:**

* {xref-validation-guide}[Validation Developer Guide] - Complete reference
* {xref-validation}[Validation System Concepts] - Architecture overview
* link:../../docs/validation-patterns.adoc[Validation Patterns^] - Best practices
* link:../../docs/adr/ADR-005-validation-devex-foundations.adoc[ADR-005^] - Design decisions

**Related guides:**

* link:run-tests-and-watch.adoc[Run Tests in Watch Mode] - Test workflow
* {xref-troubleshooting}[Troubleshooting] - Common validation issues
