= Troubleshooting Guide
include::partial$attributes.adoc[]

[[overview]]
== Overview

Common issues and solutions for Boundary development and deployment.

[[database-issues]]
== Database Issues

[[db-connection-failed]]
=== Database Connection Failed

**Symptoms:**

* "Connection refused" error
* "Unable to connect to database" message
* Tests fail with connection errors

**Solutions:**

[source,{shell}]
----
# Check if SQLite file exists
ls dev-database.db

# For PostgreSQL, verify service is running
ps aux | grep postgres

# Test PostgreSQL connection
psql -h localhost -U boundary_dev -d boundary_dev

# Verify environment variables
echo $POSTGRES_HOST
echo $POSTGRES_PORT
echo $POSTGRES_DB
----

[[db-schema-not-initialized]]
=== Database Schema Not Initialized

**Symptoms:**

* "Table does not exist" errors
* "Relation 'users' does not exist"

**Solutions:**

[source,{shell}]
----
# In REPL, initialize schema
(require '[boundary.user.shell.persistence :as persistence])
(require '[boundary.shell.adapters.database.factory :as db-factory])

(let [config (boundary.config/load-config)
      db-config (get-in config [:boundary/sqlite])
      db-ctx (db-factory/db-context db-config)]
  (persistence/initialize-user-schema! db-ctx))
----

[[db-migration-conflicts]]
=== Migration Conflicts

**Symptoms:**

* Schema version mismatch errors
* Migration failures

**Solutions:**

[source,{shell}]
----
# Delete database and recreate (development only!)
rm dev-database.db
clojure -M:repl-clj
# Schema will be recreated automatically
----

[[repl-issues]]
== REPL Issues

[[repl-wont-start]]
=== REPL Won't Start

**Symptoms:**

* REPL hangs on startup
* Connection timeout errors

**Solutions:**

[source,{shell}]
----
# Clean Clojure cache
rm -rf .cpcache

# Check for port conflicts
lsof -i :7888

# Kill conflicting process if needed
kill <PID>

# Start REPL
clojure -M:repl-clj
----

[[repl-state-corrupted]]
=== REPL State Corrupted

**Symptoms:**

* "Var is unbound" errors
* Unexpected behavior after code changes

**Solutions:**

[source,clojure]
----
;; Reset Integrant system
(require '[integrant.repl :as ig-repl])
(ig-repl/halt)
(ig-repl/go)

;; Or restart REPL completely
;; Exit and start fresh REPL
----

[[repl-namespace-not-found]]
=== Namespace Not Found

**Symptoms:**

* "Could not locate..." errors
* "No such namespace" warnings

**Solutions:**

[source,clojure]
----
;; Ensure file is saved
;; Check namespace declaration matches file path

;; For src/boundary/user/core/user.clj:
(ns boundary.user.core.user)  ; âœ… Correct

;; Reload namespace
(require 'boundary.user.core.user :reload)
----

[[test-issues]]
== Test Issues

[[tests-fail-no-driver]]
=== Tests Fail: Database Driver Not Found

**Symptoms:**

* "No suitable driver found" error
* "ClassNotFoundException: org.h2.Driver"

**Solutions:**

[source,{shell}]
----
# Use :db/h2 alias for tests
clojure -M:test:db/h2

# NOT just:
# clojure -M:test
----

[[tests-fail-watch-mode]]
=== Tests Fail Only in Watch Mode

**Symptoms:**

* Tests pass individually
* Tests fail in watch mode
* State pollution between runs

**Solutions:**

[source,clojure]
----
;; Add proper test fixtures
(use-fixtures :each
  (fn [test-fn]
    ;; Setup
    (initialize-test-db!)
    ;; Run test
    (test-fn)
    ;; Cleanup
    (cleanup-test-db!)))
----

[[snapshot-test-failures]]
=== Snapshot Test Failures

**Symptoms:**

* "Snapshot mismatch" errors
* Tests fail after valid code changes

**Solutions:**

[source,{shell}]
----
# Update snapshots after intentional changes
UPDATE_SNAPSHOTS=true clojure -M:test:db/h2 --focus validation-snapshot

# Verify changes are correct
cat test/snapshots/user-validation-*.edn

# Run tests to confirm
clojure -M:test:db/h2 --focus validation-snapshot
----

[[cli-issues]]
== CLI Issues

[[cli-command-not-found]]
=== CLI Command Not Found

**Symptoms:**

* "Unknown command" errors
* CLI help not showing commands

**Solutions:**

[source,{shell}]
----
# Verify CLI alias exists
grep -A 5 ':cli' deps.edn

# Use correct command format
clojure -M:cli user-create --email test@example.com ...

# NOT:
# clojure -M:cli create-user ...
----

[[cli-json-parse-error]]
=== CLI JSON Parse Error

**Symptoms:**

* "Invalid JSON" in scripts
* jq errors when parsing output

**Solutions:**

[source,{shell}]
----
# Ensure --format json flag is used
clojure -M:cli user-list \
  --tenant-id "$TENANT_ID" \
  --format json  # Required for JSON output

# Check for error messages in output
clojure -M:cli user-list --tenant-id "$TENANT_ID" --format json 2>&1
----

[[validation-issues]]
== Validation Issues

[[validation-devex-not-working]]
=== Enhanced Validation Not Working

**Symptoms:**

* Simple error messages instead of enhanced
* No "Did you mean?" suggestions

**Solutions:**

[source,{shell}]
----
# Enable feature flag
export BND_DEVEX_VALIDATION=true

# Verify in REPL
(require '[boundary.shared.core.config.feature-flags :as flags])
(flags/enabled? :devex-validation)
;; Should return true

# Restart application
clojure -M:repl-clj
----

[[validation-false-positives]]
=== Validation False Positives

**Symptoms:**

* Valid data rejected
* Unexpected validation errors

**Solutions:**

[source,clojure]
----
;; Test schema in REPL
(require '[malli.core :as m])
(require '[boundary.user.schema :as schema])

;; Validate data
(m/validate schema/User test-data)

;; See detailed errors
(m/explain schema/User test-data)
----

[[build-issues]]
== Build Issues

[[build-dependency-conflicts]]
=== Dependency Conflicts

**Symptoms:**

* "Version conflict" warnings
* ClassNotFoundException at runtime

**Solutions:**

[source,{shell}]
----
# View dependency tree
clojure -X:deps tree

# Check for conflicts
clojure -X:deps tree | grep -A 2 "CONFLICT"

# Clear Maven cache
rm -rf ~/.m2/repository

# Rebuild
clojure -M:test:db/h2
----

[[build-out-of-memory]]
=== Out of Memory Errors

**Symptoms:**

* "java.lang.OutOfMemoryError: Java heap space"
* Build process killed

**Solutions:**

[source,{shell}]
----
# Increase heap size
export CLJ_JVM_OPTS="-Xmx2g"

# Or create .clojure/deps.edn in project root
echo '{:aliases {:dev {:jvm-opts ["-Xmx2g"]}}}' > .clojure/deps.edn

# Rebuild
clojure -M:test:db/h2
----

[[performance-issues]]
== Performance Issues

[[slow-test-suite]]
=== Slow Test Suite

**Symptoms:**

* Tests take minutes to run
* Individual tests are slow

**Solutions:**

[source,{shell}]
----
# Run only fast unit tests (metadata-based)
clojure -M:test:db/h2 --focus-meta :unit

# Skip slow integration tests during development
clojure -M:test:db/h2 --skip-meta :slow

# Use watch mode with focus on unit tests
clojure -M:test:db/h2 --watch --focus-meta :unit
----

[[slow-repl-startup]]
=== Slow REPL Startup

**Symptoms:**

* REPL takes >30 seconds to start
* Long dependency resolution

**Solutions:**

[source,{shell}]
----
# Use local Maven cache
mkdir -p ~/.m2/repository

# Check for network issues
ping repo1.maven.org

# Use faster mirror (if needed)
# Add to ~/.clojure/deps.edn:
# {:mvn/repos {"central" {:url "https://repo1.maven.org/maven2/"}}}
----

[[production-issues]]
== Production Issues

[[config-not-loaded]]
=== Configuration Not Loaded

**Symptoms:**

* Application starts with wrong config
* Environment variables ignored

**Solutions:**

[source,{shell}]
----
# Verify BND_ENV is set
echo $BND_ENV

# Check config file exists for environment
ls resources/conf/$BND_ENV/config.edn

# Test config loading
clojure -M:repl-clj
(require '[boundary.config :as config])
(config/load-config)
----

[[memory-leak]]
=== Memory Leak

**Symptoms:**

* Memory usage grows over time
* OutOfMemoryError after hours of operation

**Solutions:**

[source,{shell}]
----
# Enable GC logging
export CLJ_JVM_OPTS="-Xlog:gc*:file=gc.log"

# Monitor heap usage
jmap -heap <PID>

# Take heap dump
jmap -dump:format=b,file=heap.hprof <PID>

# Analyze with VisualVM or Eclipse MAT
----

[[get-help]]
== Getting Help

[[check-logs]]
=== Check Logs

[source,{shell}]
----
# Application logs
tail -f logs/boundary.log

# Test output with details
clojure -M:test:db/h2 --reporter kaocha.report/documentation
----

[[debug-mode]]
=== Enable Debug Mode

[source,clojure]
----
;; In REPL, enable debug logging
(require '[taoensso.telemere :as log])
(log/set-min-level! :debug)

;; Or via environment
;; export LOG_LEVEL=debug
----

[[common-commands]]
=== Common Diagnostic Commands

[source,{shell}]
----
# Check Java version
java -version

# Check Clojure CLI version
clojure --version

# Verify project structure
tree -L 3 src/

# Check for syntax errors
clojure -M:clj-kondo --lint src test

# List all deps.edn aliases
grep -E '^\s+:' deps.edn
----

[[learn-more]]
== Learn More

* xref:../how-to/run-tests-and-watch.adoc[Run Tests and Watch]
* xref:../how-to/configure-db.adoc[Configure Database]
* xref:reference/configuration.adoc[Configuration Reference]
* xref:reference/error-codes.adoc[Error Codes Reference]