#
# Boundary Framework - Docker Compose Configuration
# Enhanced with intelligent port management and development optimization
#

services:
  # PostgreSQL Database
  db:
    image: postgres:18
    container_name: boundary-db
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-boundary_dev}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    ports:
      # PostgreSQL port - can be overridden via POSTGRES_PORT env var
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - boundary_pgdata:/var/lib/postgresql/data
      # Optional: Custom init scripts
      - ./resources/db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-boundary_dev}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - boundary-network

  # Main Application
  app:
    build:
      context: .
      dockerfile: resources/conf/dev/Dockerfile
      target: ${BUILD_TARGET:-runtime}
    image: boundary-app:${VERSION:-dev}
    container_name: boundary-app
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Database connection
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-boundary_dev}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      
      # Application configuration
      - HTTP_PORT=${HTTP_PORT:-3000}
      - HTTP_HOST=${HTTP_HOST:-0.0.0.0}
      - PROFILE=${PROFILE:-dev}
      - DEFAULT_TENANT_ID=${DEFAULT_TENANT_ID:-00000000-0000-0000-0000-000000000001}
      
      # Docker environment markers
      - DOCKER_CONTAINER=true
      - CONTAINER_NAME=boundary-app
      
      # JVM tuning for containers
      - JAVA_OPTS=${JAVA_OPTS:--Xmx512m -Xms128m -XX:+UseG1GC -XX:+UseContainerSupport}
      
    ports:
      # Main application port - can be overridden via HTTP_PORT env var
      - "${HTTP_PORT:-3000}:${HTTP_PORT:-3000}"
      # Development mode: expose port range for auto-allocation
      - "${HTTP_PORT_RANGE_START:-3001}-${HTTP_PORT_RANGE_END:-3010}:${HTTP_PORT_RANGE_START:-3001}-${HTTP_PORT_RANGE_END:-3010}"
    volumes:
      # Configuration override
      - ./resources/conf/dev:/app/resources/conf/dev:ro
      # Development mode: live reload support
      - ./src:/app/src:ro
      - ./resources:/app/resources:ro
      # Logs directory
      - boundary_logs:/app/logs
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${HTTP_PORT:-3000}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - boundary-network
    restart: unless-stopped

  # Documentation Server (Optional)
  docs:
    image: node:18-alpine
    container_name: boundary-docs
    working_dir: /app
    command: sh -c "npm install && npm run build-docs && npm run serve-docs"
    environment:
      - NODE_ENV=development
      - DOCKER_CONTAINER=true
      - DOCS_PORT=${DOCS_PORT:-8080}
    ports:
      - "${DOCS_PORT:-8080}:${DOCS_PORT:-8080}"
    volumes:
      - .:/app:ro
      - /app/node_modules
      - boundary_docs:/app/resources/public/docs
    networks:
      - boundary-network
    profiles:
      - docs
      - full

  # Development Tools Container (Optional)
  dev-tools:
    image: clojure:openjdk-17-tools-deps
    container_name: boundary-dev-tools
    working_dir: /app
    command: tail -f /dev/null  # Keep container running
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-boundary_dev}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    volumes:
      - .:/app
      - boundary_m2_cache:/root/.m2
      - boundary_clj_cache:/root/.clojure
    networks:
      - boundary-network
    profiles:
      - dev
      - full

# Networks
networks:
  boundary-network:
    driver: bridge
    name: boundary-network

# Volumes
volumes:
  boundary_pgdata:
    name: boundary_pgdata
    driver: local
  boundary_logs:
    name: boundary_logs
    driver: local
  boundary_docs:
    name: boundary_docs
    driver: local
  boundary_m2_cache:
    name: boundary_m2_cache
    driver: local
  boundary_clj_cache:
    name: boundary_clj_cache
    driver: local